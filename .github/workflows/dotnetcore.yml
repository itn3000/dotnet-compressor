name: .NET Core Build

on: [push]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: ["ubuntu-18.04", "windows-latest", "macos-latest"]
        rid: ["linux-x64", "win-x64", "osx-x64"]
        linker: ["", "clang-6.0"]
        exclude:
          - os: "windows-latest"
            rid: "linux-x64"
          - os: "macos-latest"
            rid: "linux-x64"
          - os: "ubuntu-18.04"
            rid: "win-x64"
          - os: "macos-latest"
            rid: "win-x64"
          - os: "windows-latest"
            rid: "osx-x64"
          - os: "ubuntu-18.04"
            rid: "osx-x64"
          - os: "windows-latest"
            linker: "clang-6.0"
          - os: "ubuntu-18.04"
            linker: ""
          - os: "macos-latest"
            linker: "clang-6.0"
    env:
      CppCompilerAndLinker: ${{ matrix.linker }}
    steps:
    - uses: actions/checkout@v1
    - name: Setup .NET Core 2.1
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: "2.1.607"
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: "3.0.101"
    - name: restore dotnet tool
      run: dotnet tool restore
    - name: Build with dotnet
      run: dotnet tool run dotnet-cake build.cake -Configuration=Release
      if: matrix.os == 'windows-latest'
    - name: collect nuget package as artifact
      uses: actions/upload-artifact@v1
      with:
        name: nupkg-${{matrix.rid}}
        path: dist/Release/nupkg
      if: matrix.os == 'windows-latest'
    - name: update apt cache
      run: sudo apt-get update 
      if: matrix.os == 'ubuntu-18.04'
    - name: installing prerequisit packages for corert
      run: sudo apt-get install -y libkrb5-dev zlib1g-dev
      if: matrix.os == 'ubuntu-18.04'
    - name: build native binary
      run: dotnet tool run dotnet-cake build.cake -Configuration=Release -Target=Native -Runtime=${{matrix.rid}}
    - name: stripping binary
      run: strip dist-bin/Release/dcomp-${{matrix.rid}}
      if: matrix.os != 'windows-latest'
    - name: collect native binary as artifact
      uses: actions/upload-artifact@v1
      with:
        name: bin-${{matrix.rid}}
        path: dist/Release/bin
  release:
    runs-on: "windows-latest"
    needs: ["build"]
    steps:
      - name: downloading nuget package
        uses: actions/download-artifact@v1
        with:
          name: "nupkg-win-x64"
          path: nupkg
      - name: downloading win-x64 binary
        uses: actions/download-artifact@v1
        with:
          name: "bin-win-x64"
          path: win-x64
      - name: downloading osx-x64 binary
        uses: actions/download-artifact@v1
        with:
          name: "bin-osx-x64"
          path: osx-x64
      - name: downloading linux-x64 binary
        uses: actions/download-artifact@v1
        with:
          name: "bin-linux-x64"
          path: linux-x64
      - name: list files
        run: cmd.exe /c dir /s
